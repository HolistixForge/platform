{
  "$schema": "../../../packages/backend-engine/src/lib/json-schemas/exec-pipe-schema.json",
  "pipelines": {
    "ping": {
      "steps": []
    },
    "event": {
      "steps": [
        {
          "type": "reduce-event",
          "args": {
            "event": "{json.event}",
            "authorizationHeader": "{headers.authorization}",
            "user_id": "{jwt.user_id}",
            "ip": "{headers.x-real-ip}",
            "jwt": "{jwt.*}"
          }
        }
      ]
    },
    "start": {
      "steps": [
        {
          "type": "api-call",
          "args": {
            "url": "https://{env.GANYMEDE_FQDN}/gateway-config",
            "method": "POST",
            "jsonBody": {
              "tmp_handshake_token": "{json.tmp_handshake_token}"
            }
          },
          "graft": ".config"
        },
        {
          "type": "start-collab",
          "args": {
            "config": "{current.config.json}"
          }
        }
      ]
    },
    "vpn": {
      "steps": [
        {
          "type": "authorization-control",
          "args": {
            "type": "jwt",
            "action": "p:{jwt.project_id}:project:vpn-access"
          }
        },
        {
          "type": "send-vpn-config",
          "args": {},
          "graft": "."
        }
      ]
    }
  }
}